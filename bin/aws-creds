#!/usr/bin/env bash
set -euo pipefail

PROFILE="default"
INPUT="-"

while [ $# -gt 0 ]; do
  case "$1" in
    -p | --profile)
      PROFILE="$2"
      shift 2
      ;;
    --profile=*)
      PROFILE="${1#--profile=}"
      shift
      ;;
    *)
      # first non-option argument = input file
      INPUT="$1"
      shift
      break
      ;;
  esac
done

if [ "$INPUT" = "-" ]; then
  INPUT="/dev/stdin"
fi

while read -r L || [ -n "$L" ]; do
  # skip empty + comment lines
  if [[ -z "$L" || "$L" == \#* ]]; then continue; fi

  K=${L%%=*}
  V=${L#*=}

  aws configure set "$K" "$V" --profile "$PROFILE"
done <"$INPUT"

echo "Updated AWS credentials for profile '$PROFILE'." >&2
